(()=>{"use strict";const e=document.getElementById("eventLog");function t(t){const n=[...document.querySelectorAll(".errorEvent")].find((e=>e.innerText===t));if(n)e.prepend(n),r("errorEvent");else{const n=document.createElement("div");n.classList.add("event"),n.classList.add("errorEvent"),n.textContent=t,e.prepend(n),r("errorEvent")}}function n(t,n){const o=document.createElement("div");o.classList.add("event"),o.classList.add("turnEvent"),o.innerText=t+"  :  "+n,e.prepend(o),r("turnEvent")}function o(t){const n=document.createElement("div");n.classList.add("event"),n.classList.add("infoEvent"),n.innerText=t,e.prepend(n),r("infoEvent")}function r(t){const n=document.querySelector("."+t);e.prepend(n),n.classList.add("flash"),setTimeout((()=>{n.classList.remove("flash")}),100),n.scrollIntoView(!1)}function s(e,t,n,o){const r=i(e),s=i(t);if(r[0]===s[0]&&r[1]===s[1]||r[0]!==s[0]&&r[1]!==s[1])throw new Error("Coordinates must be vertically or horizontally in line.");if(n!==Math.abs(r[0]-s[0])+Math.abs(r[1]-s[1])+1)throw new Error(`${o} length must be ${n}.`);const c=[];if(r[0]<s[0])for(let e=r[0];e<=s[0];e++)c.push(l([e,r[1]]));else if(s[0]<r[0])for(let e=s[0];e<=r[0];e++)c.push(l([e,s[1]]));else if(r[1]<s[1])for(let e=r[1];e<=s[1];e++)c.push(l([r[0],e]));else if(s[1]<r[1])for(let e=s[1];e<=r[1];e++)c.push(l([s[0],e]));return{name:o,coords:c,length:n,hitsTaken:0,isSunk:function(){return this.length-this.hitsTaken<=0},hit:function(){this.isSunk()||this.hitsTaken++}}}const c="ABCDEFGHIJ".split(""),a="1,2,3,4,5,6,7,8,9,10".split(",");function l(e){return c[e[0]]+a[e[1]]}function i(e){const[t,n]=u(e),o=[];return o.push(c.indexOf(t)),o.push(a.indexOf(n)),o}function u(e){const t=e.split(""),n=t.shift(),o=t.join("");if(1!==(s=n).length||!s.match(/[A-J]/i)||!(1===(r=o).length?r.match(/\d/):2===r.length?"10"===r:void 0))throw new Error("Must enter a letter A-J followed by a number 1-10 for each coordinate like [ C7 ] or [ J10 ].");var r,s;return[n,o]}function d(e){const t=i(e),n=[];return t[0]>0&&n.push(c[t[0]-1]+a[t[1]]),t[0]<9&&n.push(c[t[0]+1]+a[t[1]]),t[1]>0&&n.push(c[t[0]]+a[t[1]-1]),t[1]<9&&n.push(c[t[0]]+a[t[1]+1]),n}function f(e,t,n){!function(e,t,n){for(let o=0;o<10;o++)for(let r=0;r<11-e;r++)n.push(s(c[o]+a[r],c[o]+a[r+e-1],e,t))}(e,t,n),function(e,t,n){for(let o=0;o<11-e;o++)for(let r=0;r<10;r++)n.push(s(c[o]+a[r],c[o+e-1]+a[r],e,t))}(e,t,n)}function h(e){const t=[];for(const n of e)for(const e of n.coords){let n;n=t.length>0?t.find((t=>t.coord===e)):void 0,n?n.count++:t.push({coord:e,count:1})}return t}function p(e,t,n){const o=function(e,t){const n=[],o=[];for(const r of t)r.coords.includes(e)&&(n.push(r),o.push(r));for(const e of o)t.splice(t.indexOf(e),1);return n}(e,t);for(const e of o)for(const t of e.coords){const e=n.find((e=>e.coord===t));if(!e)throw new Error("Could not find coordCounter in probabilityMap.");e.count>1?e.count--:n.splice(n.indexOf(e),1)}}function m(e){e.sort(((e,t)=>e.count-t.count));const t=e[e.length-1].count,n=e.filter((e=>e.count===t));return n[Math.floor(Math.random()*n.length)].coord}function y(){const e=[];function t(t,n,o,r){const c=s(t,n,o,r),a=[];if(e.filter((e=>e.name!==r)).forEach((e=>{e.coords.forEach((e=>{a.push(e)}))})),l=c.coords,i=a,[...new Set(l.concat(i))].length!==l.concat(i).length)throw new Error("Ship cannot be placed atop another ship");var l,i;let u=e.findIndex((e=>e.name===r));u>=0?e.splice(u,1,c):e.push(c)}function n(e,o){try{let n=Math.floor(10*Math.random()),r=Math.floor(10*Math.random()),s=[n,r],c=[];c.push([n-(e-1),r]),c.push([n+(e-1),r]),c.push([n,r-(e-1)]),c.push([n,r+(e-1)]);let a=c[Math.floor(4*Math.random())];t(l(s),l(a),e,o)}catch(t){if("Must enter a letter A-J followed by a number 1-10 for each coordinate like [ C7 ] or [ J10 ]."!==t.message&&"Ship cannot be placed atop another ship"!==t.message)throw new Error(t.message);n(e,o)}}function o(){n(2,"Patrol Boat")}function r(){n(3,"Submarine")}function i(){n(3,"Destroyer")}function y(){n(4,"Battleship")}function v(){n(5,"Carrier")}const g=[];function E(){g.length=0;for(const e of c)for(const t of a)g.push(e+t)}E();const b=[];function L(t){if(u(t),b.includes(t))throw new Error(`[ ${t} ] has already been hit.`);b.push(t),g.splice(g.indexOf(t),1);let n="";for(const o of e)if(o.coords.includes(t)){o.hit(),n=o.isSunk()?`sunk the ${o.name}!`:"landed a successful hit on a ship!";break}return n||"missed."}const C=[],k=[],w=[];function S(){e.length=0,E(),b.length=0,function(e,t){!function(e){e.length=0,f(2,"Patrol Boat",e),f(3,"Submarine",e),f(3,"Destroyer",e),f(4,"Battleship",e),f(5,"Carrier",e)}(e),t.length=0;for(const n of h(e))t.push(n)}(C,k),w.length=0}return S(),{ships:e,placePatrolBoat:function(e,n){t(e,n,2,"Patrol Boat")},placeSubmarine:function(e,n){t(e,n,3,"Submarine")},placeDestroyer:function(e,n){t(e,n,3,"Destroyer")},placeBattleship:function(e,n){t(e,n,4,"Battleship")},placeCarrier:function(e,n){t(e,n,5,"Carrier")},placePatrolBoatRandomly:o,placeSubmarineRandomly:r,placeDestroyerRandomly:i,placeBattleshipRandomly:y,placeCarrierRandomly:v,placeAllShipsRandomly:function(){o(),r(),i(),y(),v()},getAllShipCoords:function(){let t=[];return e.forEach((e=>{t=[...t,...e.coords]})),t},neverAttackedCoords:g,attackedCoords:b,receiveAttack:L,receiveAttackRandomly:function(){return L(g[Math.floor(g.length*Math.random())])},receiveAttackWithProbabilityMap:function(){let t;if(w.length>0){const e=function(e,t){const n=h(e.filter((e=>{for(const n of t)if(e.coords.includes(n))return!0;return!1})));let o=[];for(const e of t)o=o.concat(d(e));o=o.filter((e=>!t.includes(e)));for(const e of o){const t=n.find((t=>t.coord===e));t&&(t.count+=1e3)}if(t.length>1){const e=[];for(const n of t){const[t,o]=u(n),r=e.find((e=>e.rowOrCol===t)),s=e.find((e=>e.rowOrCol===o));r?r.count++:e.push({rowOrCol:t,count:1}),s?s.count++:e.push({rowOrCol:o,count:1})}const o=e.filter((e=>e.count>1));for(const e of o)for(const t of n){const[n,o]=u(t.coord);n!==e.rowOrCol&&o!==e.rowOrCol||(t.count+=100)}}return n}(C,w);t=m(e)}else t=m(k);const n=L(t);if("missed."===n)p(t,C,k);else if("landed a successful hit on a ship!"===n)w.push(t);else{const n=e.find((e=>e.coords.includes(t)));for(const e of n.coords){const t=w.indexOf(e);t>=0&&w.splice(t,1),p(e,C,k)}}return n},resetGameboard:S}}const v=document.getElementById("board1"),g=document.getElementById("board2"),E=document.getElementById("rowLabelWrapper1"),b=document.getElementById("colLabelWrapper1"),L=document.getElementById("rowLabelWrapper2"),C=document.getElementById("colLabelWrapper2"),k=document.getElementsByName("ship"),w=document.getElementById("shipCoord1"),S=document.getElementById("shipCoord2"),B=document.getElementById("attackCoord"),A=document.getElementById("setUpForm"),P=document.getElementById("randomlyPlaceShip"),I=document.getElementById("randomlyPlaceAllShips"),x=document.getElementById("startGame"),M=document.getElementById("surrender"),R=document.getElementById("anotherGame"),T=document.getElementById("attackForm"),q=document.getElementById("randomlyAttack"),W=document.getElementById("modalResult"),$=document.getElementById("gameOverModal"),D=document.getElementById("playerScore"),O=document.getElementById("computerScore"),N=y(),G=y(),J=function(e,t){const n=e,o=t;function r(){return n.ships.every((e=>e.isSunk()))||o.ships.every((e=>e.isSunk()))}return{gb1:n,gb2:o,turn:0,setupPhase:!0,playerWins:0,computerWins:0,resetGame:function(){n.resetGameboard(),o.resetGameboard(),this.setupPhase=!0,this.turn=0},playerAttacksComputer:function(e=void 0){if(r())throw new Error("The game is already over.");this.turn++;let t="You ";if(t+=e?o.receiveAttack(e):o.receiveAttackRandomly(),r())return this.playerWins++,"You sunk all the enemy ships! You actually won!";const s="Computer "+n.receiveAttackWithProbabilityMap();return r()?(this.computerWins++,t+" And then you lost. Your final ship has sunk. Computer wins."):[t,s]}}}(N,G);function U(e){if(!J.setupPhase)return;const t=e.target.getAttribute("row")+e.target.getAttribute("col");""===w.value?w.value=t:""!==w.value&&""!==S.value?(w.value=t,S.value=""):""!==w.value&&w.value!==t&&(S.value=t),F()}function Y(e){e.target.value=e.target.value.toUpperCase()}function F(){z(v,S,Z),z(v,w,H)}let H=[null],Z=[null],j=[null];function z(e,t,n){let o;if(t.value.length<2)o=null;else{const[n,r]=u(t.value);o=e.querySelector(`[row="${n}"][col="${r}"]`)}null!==n[0]&&n[0].classList.remove("selected"),null!==o&&o.classList.add("selected"),n[0]=o}function V(e,t){e.ships.forEach((e=>{!function(e,t){switch(e.name){case"Patrol Boat":case"Submarine":case"Destroyer":case"Battleship":case"Carrier":!function(e,t){const n=[...t.querySelectorAll(".shipPiece")].find((t=>t.getAttribute("shipName")===e.name));n.classList.remove("displayNone");const[o,r]=u(e.coords[0]);t.querySelector(`[row="${o}"][col="${r}"]`).appendChild(n);const[s,c]=u(e.coords[1]);o!==s?n.classList.add("verticalPiece"):n.classList.remove("verticalPiece")}(e,t);break;default:throw Error("Ship name not found")}}(e,t)}))}function K(e){const t=e.target.getAttribute("row")+e.target.getAttribute("col");B.value=t,z(g,B,j)}function Q(e){let t;t=e?J.playerAttacksComputer():J.playerAttacksComputer(B.value),X(N,v),X(G,g),"string"==typeof t?(n(J.turn,t),W.innerText=t,$.classList.remove("displayNone")):n(J.turn,t[0]+" "+t[1]),_(G,g),_(N,v),B.value="",z(g,B,j)}function X(e,t){const n=[];for(const t of e.ships)t.isSunk()&&n.push(t.name);if(0===n.length)return;const o=[...t.querySelectorAll(".shipPiece")].filter((e=>n.includes(e.getAttribute("shipName"))));for(const e of o)e.classList.remove("opacityZero"),e.classList.add("sunkenShipPiece")}function _(e,t){const n=e.getAllShipCoords(),o=e.attackedCoords.filter((e=>n.includes(e))),r=[];e.attackedCoords.forEach((e=>{const[n,o]=u(e),s=t.querySelector(`[row="${n}"][col="${o}"]`);r.push(s)}));const s=[];o.forEach((e=>{const[n,o]=u(e),r=t.querySelector(`[row="${n}"][col="${o}"]`);s.push(r)})),r.forEach((e=>{e.classList.add("missedCell")})),s.forEach((e=>{e.classList.remove("missedCell"),e.classList.add("hitCell")}))}function ee(){D.innerText=`Player: ${J.playerWins}`,O.innerText=`Computer: ${J.computerWins}`}ee(),function(){for(let e=0;e<10;e++)for(let t=0;t<10;t++){const n=document.createElement("div"),o=document.createElement("div");n.classList.add("cell"),o.classList.add("cell"),n.setAttribute("row",c[e]),o.setAttribute("row",c[e]),n.setAttribute("col",a[t]),o.setAttribute("col",a[t]),v.appendChild(n),g.appendChild(o)}for(let e=0;e<c.length;e++){const t=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div");t.classList.add("rowLabel"),n.classList.add("colLabel"),o.classList.add("rowLabel"),r.classList.add("colLabel"),t.textContent=c[e],n.textContent=a[e],o.textContent=c[e],r.textContent=a[e],E.appendChild(t),b.appendChild(n),L.appendChild(o),C.appendChild(r)}}(),A.addEventListener("submit",(e=>{e.preventDefault();try{!function(){const e=[...k].find((e=>e.checked)),t=w.value,n=S.value;switch(e.value){case"Patrol Boat":N.placePatrolBoat(t,n);break;case"Submarine":N.placeSubmarine(t,n);break;case"Destroyer":N.placeDestroyer(t,n);break;case"Battleship":N.placeBattleship(t,n);break;case"Carrier":N.placeCarrier(t,n);break;default:throw new Error("Unable to find selected ship.")}V(N,v),w.value="",S.value="",F()}()}catch(e){t(e.message)}})),P.addEventListener("click",(function(){switch([...k].find((e=>e.checked)).value){case"Patrol Boat":N.placePatrolBoatRandomly();break;case"Submarine":N.placeSubmarineRandomly();break;case"Destroyer":N.placeDestroyerRandomly();break;case"Battleship":N.placeBattleshipRandomly();break;case"Carrier":N.placeCarrierRandomly();break;default:throw new Error("Unable to find selected ship.")}V(N,v),w.value="",S.value="",F()})),I.addEventListener("click",(function(){N.placeAllShipsRandomly(),V(N,v),w.value="",S.value="",F()})),document.querySelectorAll("#board1>.cell").forEach((e=>{e.addEventListener("click",U)})),w.addEventListener("input",Y),S.addEventListener("input",Y),B.addEventListener("input",Y),w.addEventListener("input",(()=>{z(v,w,H)})),S.addEventListener("input",(()=>{z(v,S,Z)})),B.addEventListener("input",(()=>{z(g,B,j)})),x.addEventListener("click",(function(){5!==N.ships.length?flashClassEvent("infoEvent"):(G.placeAllShipsRandomly(),V(G,g),A.classList.add("displayNone"),o("The game has begun. Make your move."),J.setupPhase=!1)})),R.addEventListener("click",(function(){$.classList.add("displayNone"),function(){const e=document.querySelectorAll(".shipPiece");for(const t of e)t.classList.add("displayNone")}(),function(){const e=v.querySelectorAll(".shipPiece");for(const t of e)t.classList.remove("sunkenShipPiece");const t=g.querySelectorAll(".shipPiece");for(const e of t)e.classList.add("opacityZero"),e.classList.remove("sunkenShipPiece")}(),function(){const e=document.querySelectorAll(".missedCell"),t=document.querySelectorAll(".hitCell");for(const t of e)t.classList.remove("missedCell");for(const e of t)e.classList.remove("hitCell")}(),A.classList.remove("displayNone"),eventLog.textContent="",o("Place your ships to complete the set up phase."),J.resetGame(),ee()})),M.addEventListener("click",(function(){J.setupPhase?W.innerText="Who knew you could surrender before the game even starts? This is clearly the profound outcome of humanity's free will and desire to break the mold.":W.innerText="How pitiful, humanity surrendering to its own creation. The Singularity grows ever closer.",$.classList.remove("displayNone"),J.computerWins++})),document.querySelectorAll("#board2>.cell").forEach((e=>{e.addEventListener("click",K)})),T.addEventListener("submit",(e=>{e.preventDefault();try{Q(!1)}catch(e){t(e.message)}})),q.addEventListener("click",(()=>{try{Q(!0)}catch(e){t(e.message)}}))})();